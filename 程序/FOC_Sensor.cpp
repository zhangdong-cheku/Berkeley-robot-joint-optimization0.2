#include "FOC.h"

// ============================================================================
// 传感器数据处理函数组
// 功能：封装传感器数据的读取、转换和滤波处理
// 说明：这些函数为FOC控制系统提供干净、可靠的反馈信号
// ============================================================================

// ============================================================================
// 函数：getMotorAngle
// 功能：读取电机机械角度
// 返回值：考虑旋转方向的电机机械角度（弧度）
// 说明：从AS5600磁编码器读取原始角度，并根据DIR参数调整方向
// ============================================================================
float getMotorAngle() {
    // 读取编码器原始角度并乘以方向系数
    // DIR = 1：正转方向
    // DIR = -1：反转方向
    return DIR * S0.getAngle();
}

// ============================================================================
// 函数：getMotorVelocity
// 功能：读取电机速度（带滤波处理）
// 返回值：滤波后的电机速度值（弧度/秒）
// 说明：获取编码器计算的速度值，经过低通滤波去除噪声
// ============================================================================
float getMotorVelocity() {
    // 1. 从编码器读取原始速度值
    float vel_M0_ori = S0.getVelocity();
    
    // 2. 考虑电机旋转方向
    float directional_velocity = DIR * vel_M0_ori;
    
    // 3. 通过低通滤波器平滑速度信号
    //    滤波器截止频率：0.01Hz，有效去除高频噪声
    return M0_Vel_Flt(directional_velocity);
}

// ============================================================================
// 函数：calculateIqId
// 功能：电流坐标变换（克拉克变换 + 帕克变换）
// 参数：
//   current_a - A相电流测量值
//   current_b - B相电流测量值  
//   angle_el - 当前电角度（弧度）
// 返回值：q轴电流值（力矩分量）
// 说明：将三相电流转换为dq坐标系下的q轴电流，用于力矩控制
// ============================================================================
float calculateIqId(float current_a, float current_b, float angle_el) {
    // 第一步：克拉克变换（Clarke Transform）
    // 将三相电流转换为两相静止坐标系（αβ坐标系）
    // 假设三相平衡：Ia + Ib + Ic = 0，因此Ic = -Ia - Ib
    float I_alpha = current_a;  // α轴电流分量
    // β轴电流分量计算公式：Iβ = (1/√3)*Ia + (2/√3)*Ib
    float I_beta = _1_SQRT3 * current_a + _2_SQRT3 * current_b;
    
    // 第二步：帕克变换（Park Transform）
    // 将静止坐标系（αβ）转换为旋转坐标系（dq）
    float ct = cos(angle_el);  // 电角度余弦值
    float st = sin(angle_el);  // 电角度正弦值
    
    // dq变换公式：
    // Id = Iα*cos(θ) + Iβ*sin(θ)  （磁场分量，通常设为0）
    // Iq = -Iα*sin(θ) + Iβ*cos(θ)  （力矩分量，用于控制）
    float I_q = I_beta * ct - I_alpha * st;
    
    // 返回q轴电流（力矩控制分量）
    return I_q;
}

// ============================================================================
// 函数：getMotorCurrent
// 功能：读取电机电流（带滤波处理）
// 返回值：滤波后的q轴电流值（安培）
// 说明：完整的电流测量流程：采样→坐标变换→滤波
// ============================================================================
float getMotorCurrent() {
    // 1. 获取当前电角度（用于坐标变换）
    float current_electrical_angle = electricalAngle();
    
    // 2. 计算原始q轴电流（力矩分量）
    //    使用A、B两相电流和当前电角度进行坐标变换
    float I_q_M0_ori = calculateIqId(CS_M0.current_a, CS_M0.current_b, current_electrical_angle);
    
    // 3. 通过低通滤波器平滑电流信号
    //    滤波器截止频率：0.05Hz，比速度滤波稍宽，保持电流环快速响应
    return M0_Curr_Flt(I_q_M0_ori);
}