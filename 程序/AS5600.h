#include <Arduino.h> 
#include "Wire.h"

// ============================================================================
// 头文件保护宏（建议添加）
// 功能：防止头文件被重复包含
// ============================================================================
// #ifndef AS5600_H
// #define AS5600_H

// ============================================================================
// 类定义：Sensor_AS5600
// 功能：AS5600磁编码器传感器驱动类
// 说明：提供位置和速度测量功能，用于FOC系统的反馈控制
// ============================================================================
class Sensor_AS5600
{
  public:
    // ============================================================================
    // 构造函数：Sensor_AS5600
    // 功能：创建传感器对象并初始化电机编号
    // 参数：Mot_Num - 电机编号，用于多电机系统区分
    // 说明：支持多电机系统，每个电机对应一个传感器实例
    // ============================================================================
    Sensor_AS5600(int Mot_Num);
    
    // ============================================================================
    // 函数：Sensor_init
    // 功能：初始化传感器硬件和软件状态
    // 参数：_wire - I2C总线对象指针，默认使用标准Wire对象
    // 说明：执行I2C总线初始化和传感器状态初始化
    // ============================================================================
    void Sensor_init(TwoWire* _wire = &Wire);
    
    // ============================================================================
    // 函数：Sensor_update
    // 功能：更新传感器数据，处理角度变化和圈数计数
    // 说明：需要在主循环中定期调用以更新传感器状态
    // ============================================================================
    void Sensor_update();
    
    // ============================================================================
    // 函数：getAngle
    // 功能：获取绝对角度（包含圈数信息）
    // 返回值：绝对角度值（弧度）
    // 说明：返回包含圈数信息的完整角度：圈数×2π + 机械角度
    // ============================================================================
    float getAngle();
    
    // ============================================================================
    // 函数：getVelocity
    // 功能：计算电机角速度
    // 返回值：角速度（弧度/秒）
    // 说明：基于角度变化和时间间隔计算瞬时角速度
    // ============================================================================
    float getVelocity();
    
    // ============================================================================
    // 函数：getMechanicalAngle
    // 功能：获取机械角度（不考虑圈数）
    // 返回值：当前机械角度（弧度，0-2π）
    // 说明：返回传感器直接测量的角度，不包含圈数信息
    // ============================================================================
    float getMechanicalAngle();
    
    // ============================================================================
    // 函数：getSensorAngle
    // 功能：从AS5600传感器读取原始角度值并转换为弧度
    // 返回值：传感器测量的角度值（弧度，0-2π）
    // 说明：通过I2C接口读取AS5600的角度寄存器原始数据
    // ============================================================================
    double getSensorAngle();
    
  private:
    // ============================================================================
    // 私有成员变量：系统配置和状态
    // ============================================================================
    
    int _Mot_Num; //!< 电机编号 - 用于多电机系统区分不同传感器
    
    // ============================================================================
    // AS5600传感器相关变量定义
    // ============================================================================
    
    // 编码器旋转方向定义（注释掉的备用功能）
    // int sensor_direction=1;  // 编码器旋转方向定义：1为正转，-1为反转
    
    // ============================================================================
    // 角度跟踪相关变量
    // ============================================================================
    
    float angle_prev = 0;        //!< 最后一次调用getSensorAngle()的输出结果
                                //!< 用于得到完整的圈数和速度计算
    
    long angle_prev_ts = 0;      //!< 上次调用getAngle的时间戳（微秒）
                                //!< 用于计算时间间隔和速度
    
    // ============================================================================
    // 速度计算相关变量
    // ============================================================================
    
    float vel_angle_prev = 0;    //!< 最后一次调用getVelocity时的角度
                                //!< 用于速度计算的差分基准
    
    long vel_angle_prev_ts = 0;  //!< 最后速度计算时间戳（微秒）
                                //!< 用于计算速度的时间间隔
    
    // ============================================================================
    // 圈数计数相关变量
    // ============================================================================
    
    int32_t full_rotations = 0;      //!< 总圈数计数
                                    //!< 记录电机旋转的总圈数（支持正负方向）
    
    int32_t vel_full_rotations = 0;  //!< 用于速度计算的先前完整旋转圈数
                                    //!< 保存上一次速度计算时的圈数状态
    
    // ============================================================================
    // I2C通信相关变量
    // ============================================================================
    
    TwoWire* wire;  //!< I2C总线对象指针
                    //!< 指向用于与AS5600通信的I2C总线对象
};

// ============================================================================
// 头文件保护宏结束（建议添加）
// ============================================================================
// #endif
